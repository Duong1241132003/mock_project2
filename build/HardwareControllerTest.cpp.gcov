        -:    0:Source:/home/duong/MediaPlayerApp/tests/controllers/HardwareControllerTest.cpp
        -:    0:Graph:/home/duong/MediaPlayerApp/build/CMakeFiles/RunTests.dir/tests/controllers/HardwareControllerTest.cpp.gcno
        -:    0:Data:/home/duong/MediaPlayerApp/build/CMakeFiles/RunTests.dir/tests/controllers/HardwareControllerTest.cpp.gcda
        -:    0:Runs:5
        -:    1:#include <gtest/gtest.h>
        -:    2:#include <gmock/gmock.h>
        -:    3:#include "controllers/HardwareController.h"
        -:    4:#include "mocks/MockSerialCommunication.h"
        -:    5:#include "models/PlaybackStateModel.h"
        -:    6:
        -:    7:using namespace media_player;
        -:    8:using namespace testing;
        -:    9:
        -:   10:class HardwareControllerTest : public Test {
        -:   11:protected:
       15:   12:    void SetUp() override {
       15:   13:        mockSerial = std::make_shared<test::MockSerialCommunication>();
       15:   14:        playbackState = std::make_shared<models::PlaybackStateModel>();
       15:   15:        controller = std::make_shared<controllers::HardwareController>(mockSerial, playbackState);
       15:   16:    }
        -:   17:
        -:   18:    std::shared_ptr<test::MockSerialCommunication> mockSerial;
        -:   19:    std::shared_ptr<models::PlaybackStateModel> playbackState;
        -:   20:    std::shared_ptr<controllers::HardwareController> controller;
        -:   21:};
        -:   22:
       20:   23:TEST_F(HardwareControllerTest, InitializeConnectsToPort) {
        -:   24:    // Expect open to be called if autoConnect fails first or we explicitly connect
        -:   25:    // HardwareController::initialize calls autoConnect first
        -:   26:    // If autoConnect fails (returns false), it tries default port
        -:   27:    
        -:   28:    // Setup expectation for isOpen check in autoConnect and connect
        5:   29:    EXPECT_CALL(*mockSerial, isOpen()).WillRepeatedly(Return(false));
        -:   30:    
        -:   31:    // autoConnect spawns a thread. This makes testing tricky.
        -:   32:    // However, initialize also calls connect fallback if autoConnect returns false.
        -:   33:    // autoConnect returns false immediately as it's async.
        -:   34:    
        -:   35:    // Then it calls connect(DEFAULT_PORT, BAUD)
       10:   36:    EXPECT_CALL(*mockSerial, open(_, 115200))
        5:   37:        .WillOnce(Return(true));
        -:   38:        
       5*:   39:    EXPECT_TRUE(controller->initialize());
        5:   40:}
------------------
_ZN52HardwareControllerTest_InitializeConnectsToPort_TestC2Ev:
        5:   23:TEST_F(HardwareControllerTest, InitializeConnectsToPort) {
------------------
_ZN52HardwareControllerTest_InitializeConnectsToPort_TestD0Ev:
        5:   23:TEST_F(HardwareControllerTest, InitializeConnectsToPort) {
------------------
_ZN52HardwareControllerTest_InitializeConnectsToPort_TestD2Ev:
        5:   23:TEST_F(HardwareControllerTest, InitializeConnectsToPort) {
------------------
_ZN52HardwareControllerTest_InitializeConnectsToPort_Test8TestBodyEv:
        5:   23:TEST_F(HardwareControllerTest, InitializeConnectsToPort) {
        -:   24:    // Expect open to be called if autoConnect fails first or we explicitly connect
        -:   25:    // HardwareController::initialize calls autoConnect first
        -:   26:    // If autoConnect fails (returns false), it tries default port
        -:   27:    
        -:   28:    // Setup expectation for isOpen check in autoConnect and connect
        5:   29:    EXPECT_CALL(*mockSerial, isOpen()).WillRepeatedly(Return(false));
        -:   30:    
        -:   31:    // autoConnect spawns a thread. This makes testing tricky.
        -:   32:    // However, initialize also calls connect fallback if autoConnect returns false.
        -:   33:    // autoConnect returns false immediately as it's async.
        -:   34:    
        -:   35:    // Then it calls connect(DEFAULT_PORT, BAUD)
       10:   36:    EXPECT_CALL(*mockSerial, open(_, 115200))
        5:   37:        .WillOnce(Return(true));
        -:   38:        
       5*:   39:    EXPECT_TRUE(controller->initialize());
        5:   40:}
------------------
        -:   41:
       20:   42:TEST_F(HardwareControllerTest, SendCurrentSongInfo) {
        5:   43:    EXPECT_CALL(*mockSerial, isOpen()).WillRepeatedly(Return(true));
        5:   44:    EXPECT_CALL(*mockSerial, sendData("SONG|Title|Artist\n")).WillOnce(Return(true));
        -:   45:    
       20:   46:    controller->sendCurrentSongInfo("Title", "Artist");
        5:   47:}
------------------
_ZN47HardwareControllerTest_SendCurrentSongInfo_TestC2Ev:
        5:   42:TEST_F(HardwareControllerTest, SendCurrentSongInfo) {
------------------
_ZN47HardwareControllerTest_SendCurrentSongInfo_TestD0Ev:
        5:   42:TEST_F(HardwareControllerTest, SendCurrentSongInfo) {
------------------
_ZN47HardwareControllerTest_SendCurrentSongInfo_TestD2Ev:
        5:   42:TEST_F(HardwareControllerTest, SendCurrentSongInfo) {
------------------
_ZN47HardwareControllerTest_SendCurrentSongInfo_Test8TestBodyEv:
        5:   42:TEST_F(HardwareControllerTest, SendCurrentSongInfo) {
        5:   43:    EXPECT_CALL(*mockSerial, isOpen()).WillRepeatedly(Return(true));
        5:   44:    EXPECT_CALL(*mockSerial, sendData("SONG|Title|Artist\n")).WillOnce(Return(true));
        -:   45:    
       20:   46:    controller->sendCurrentSongInfo("Title", "Artist");
        5:   47:}
------------------
        -:   48:
       20:   49:TEST_F(HardwareControllerTest, SendPlaybackState) {
        5:   50:    EXPECT_CALL(*mockSerial, isOpen()).WillRepeatedly(Return(true));
        5:   51:    EXPECT_CALL(*mockSerial, sendData("STATE|PLAYING\n")).WillOnce(Return(true));
        -:   52:    
        5:   53:    controller->sendPlaybackState(true);
        5:   54:}
------------------
_ZN45HardwareControllerTest_SendPlaybackState_TestC2Ev:
        5:   49:TEST_F(HardwareControllerTest, SendPlaybackState) {
------------------
_ZN45HardwareControllerTest_SendPlaybackState_TestD0Ev:
        5:   49:TEST_F(HardwareControllerTest, SendPlaybackState) {
------------------
_ZN45HardwareControllerTest_SendPlaybackState_TestD2Ev:
        5:   49:TEST_F(HardwareControllerTest, SendPlaybackState) {
------------------
_ZN45HardwareControllerTest_SendPlaybackState_Test8TestBodyEv:
        5:   49:TEST_F(HardwareControllerTest, SendPlaybackState) {
        5:   50:    EXPECT_CALL(*mockSerial, isOpen()).WillRepeatedly(Return(true));
        5:   51:    EXPECT_CALL(*mockSerial, sendData("STATE|PLAYING\n")).WillOnce(Return(true));
        -:   52:    
        5:   53:    controller->sendPlaybackState(true);
        5:   54:}
------------------
        -:   55:
        -:   56:// TODO: Test callbacks and data parsing. 
        -:   57:// Requires exposing onSerialDataReceived or using the callback registered to serial.
